<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trollchipss - Tarefas</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/yourfontawesomekit.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --accent:#2f7be2; --muted:#95a0b8; --glass:rgba(255,255,255,0.03);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#041024,#071226);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .panel{width:100%;max-width:980px;background:linear-gradient(180deg,var(--card),#071027);border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}
    .header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{font-weight:700;color:var(--accent);font-size:20px}
    .small{color:var(--muted);font-size:13px}
    form .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    input[type=text], input[type=password], input[type=number]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .buttons{display:flex;gap:12px;margin-top:8px}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#2fa0ff);color:#fff;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .tasks-panel{margin-top:16px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .task-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
    .task-item .title{font-weight:600}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    .toasts{position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .toast{padding:10px 14px;border-radius:10px;min-width:220px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04)}
    .toast.success{border-left:4px solid #20c997}
    .toast.error{border-left:4px solid #ff6b6b}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
    @media(max-width:600px){.header{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="panel" id="app">
    <div class="header">
      <div>
        <div class="logo">Trollchipss • Tarefas</div>
        <div class="small">Automação de tarefas — EDUSP</div>
      </div>
      <div style="margin-left:auto">
        <span id="userNick" class="small"></span>
      </div>
    </div>

    <div id="loginBox">
      <label for="ra">RA</label>
      <input id="ra" type="text" placeholder="ex: 123456790sp" />
      <label for="pwd">Senha</label>
      <input id="pwd" type="password" placeholder="Senha" />
      <div class="buttons">
        <button class="btn" id="btnPending">Lições Pendentes</button>
        <button class="btn secondary" id="btnExpired">Lições Expiradas</button>
      </div>
    </div>

    <div id="tasksBox" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small" id="tasksInfo">0 lições</div>
        <div>
          <label for="minTime" class="small">Tempo min (min)</label>
          <input id="minTime" type="number" value="1" style="width:80px;display:inline-block" />
          <label for="maxTime" class="small" style="margin-left:8px">Tempo max (min)</label>
          <input id="maxTime" type="number" value="3" style="width:80px;display:inline-block" />
        </div>
      </div>

      <div class="tasks-panel" id="listTasks"></div>

      <div class="controls">
        <label><input type="checkbox" id="selectAll" /> Selecionar todas</label>
        <button class="btn" id="processSelected">Processar selecionadas</button>
        <button class="btn secondary" id="processAll">Processar todas</button>
        <label style="margin-left:auto"><input id="draft" type="checkbox" /> Salvar rascunho</label>
      </div>

      <div class="footer">
        <div>Depois do deploy atualize <code>PY_SERVER</code> no script para a URL do Render.</div>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    // === CONFIGURE ===
    const PY_SERVER = 'https://trollchipss-tarefas.onrender.com'; // <- atualize com sua URL do Render

    // Utils de toasts
    function toast(msg, type='info', duration=5000){
      const el = document.createElement('div');
      el.className = 'toast ' + (type === 'success' ? 'success' : (type==='error' ? 'error' : ''));
      el.textContent = msg;
      document.getElementById('toasts').appendChild(el);
      setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(),400) }, duration);
    }

    // DOM refs
    const raInput = document.getElementById('ra');
    const pwdInput = document.getElementById('pwd');
    const btnPending = document.getElementById('btnPending');
    const btnExpired = document.getElementById('btnExpired');
    const loginBox = document.getElementById('loginBox');
    const tasksBox = document.getElementById('tasksBox');
    const listTasks = document.getElementById('listTasks');
    const tasksInfo = document.getElementById('tasksInfo');
    const selectAll = document.getElementById('selectAll');
    const processSelected = document.getElementById('processSelected');
    const processAll = document.getElementById('processAll');
    const minTime = document.getElementById('minTime');
    const maxTime = document.getElementById('maxTime');
    const draftBox = document.getElementById('draft');
    const userNick = document.getElementById('userNick');

    let AUTH_TOKEN = null;
    let CURRENT_TASKS = [];
    let CURRENT_FILTER = 'pending';

    async function postJSON(path, body){
      const res = await fetch(`${PY_SERVER}${path}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return res.json();
    }

    async function attemptLogin(filter){
      const ra = raInput.value.trim();
      const pw = pwdInput.value.trim();
      if(!ra || !pw){ toast('Preencha RA e senha', 'error'); return; }
      toast('Fazendo login...', 'info', 1800);
      try{
        const r = await postJSON('/auth', { ra, password: pw });
        if(!r.success){ toast('Login falhou: ' + (r.message || 'verifique RA/senha'), 'error'); return; }
        AUTH_TOKEN = r.auth_token;
        userNick.textContent = r.nick || '';
        toast('Login bem-sucedido', 'success');
        // carrega tasks
        await loadTasks(filter);
      }catch(e){
        console.error(e);
        toast('Erro ao conectar backend', 'error');
      }
    }

    async function loadTasks(filter){
      CURRENT_FILTER = filter;
      toast('Buscando tarefas...', 'info', 1500);
      try{
        const r = await postJSON('/tasks', { auth_token: AUTH_TOKEN, filter });
        if(!r.success){ toast('Falha ao listar tarefas', 'error'); return; }
        CURRENT_TASKS = r.tasks || [];
        renderTasks(CURRENT_TASKS);
        loginBox.style.display = 'none';
        tasksBox.style.display = 'block';
      }catch(e){
        console.error(e);
        toast('Erro ao buscar tarefas', 'error');
      }
    }

    function renderTasks(items){
      listTasks.innerHTML = '';
      tasksInfo.textContent = `${items.length} lições`;
      items.forEach((t, idx) => {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.dataset.index = idx;
        const ch = document.createElement('input');
        ch.type = 'checkbox';
        ch.className = 'task-ch';
        ch.dataset.idx = idx;
        const title = document.createElement('div');
        title.innerHTML = `<div class="title">${t.title || t.name || 'Sem título'}</div><div class="small">${t.room || ''} • id:${t.id || t.task_id || ''}</div>`;
        div.appendChild(ch);
        div.appendChild(title);
        listTasks.appendChild(div);
      });
    }

    selectAll.addEventListener('change', ()=> {
      document.querySelectorAll('.task-ch').forEach(cb => cb.checked = selectAll.checked);
    });

    btnPending.addEventListener('click', ()=> attemptLogin('pending'));
    btnExpired.addEventListener('click', ()=> attemptLogin('expired'));

    processSelected.addEventListener('click', async ()=>{
      const checked = Array.from(document.querySelectorAll('.task-ch')).filter(c=>c.checked).map(c=>CURRENT_TASKS[parseInt(c.dataset.idx)]);
      if(checked.length===0){ toast('Nenhuma tarefa selecionada', 'error'); return; }
      await sendToComplete(checked);
    });

    processAll.addEventListener('click', async ()=> {
      if(CURRENT_TASKS.length===0){ toast('Sem tarefas', 'error'); return; }
      await sendToComplete(CURRENT_TASKS);
    });

    async function sendToComplete(tasks){
      const tmin = parseInt(minTime.value) || 1;
      const tmax = parseInt(maxTime.value) || (tmin+1);
      const is_draft = draftBox.checked || false;
      toast(`Enviando ${tasks.length} tarefas...`, 'info', 2000);
      try{
        const payload = { auth_token: AUTH_TOKEN, tasks, time_min: tmin, time_max: tmax, is_draft };
        // envia
        const resp = await postJSON('/complete', payload);
        if(!resp.success){ toast('Erro no processamento: ' + (resp.message||''), 'error'); return; }
        // mostra resultados individuais
        (resp.results || []).forEach(r => {
          if(r && r.success) toast(`OK: ${r.task_id || r.title || 'tarefa'}`, 'success', 3500);
          else toast(`ERRO: ${r.task_id || r.title || ''} ${r.message || (r.error||'')}`, 'error', 3500);
        });
      }catch(e){
        console.error(e);
        toast('Erro ao enviar para processamento', 'error');
      }
    }

    // health check / backend alive
    async function checkBackend(){
      try{
        const r = await fetch(`${PY_SERVER}/health`);
        if(!r.ok) throw new Error('no');
        return true;
      }catch(e){
        toast('Backend indisponível. Atualize PY_SERVER', 'error', 7000);
        return false;
      }
    }

    // quick check on load
    (async ()=> {
      await checkBackend();
    })();

  </script>
</body>
  </html>
